<?php  include_once("cn.php");define("ID_SESSION",$_SESSION[KSJZXID]);if(chekAjax()){	function loaddx(){ 		$total=0;$js = json_decode(file_get_contents("php://input"));		 $year=isset($js->year)?$js->year:date('Y');$mois=isset($js->mois)?$js->mois:date('m'); $date="  YEAR(`date_vente`)='$year'";		if(isset($js->mois)){if($js->mois!="-1"){$date.=" AND MONTH(`date_vente`)='$mois'";}}		$total= SQL_GET_TABLE_SIZE("SELECT count(*)as cnt FROM ".COMMANDES." WHERE   $date  ORDER BY id DESC  ",2);		$newdata=array();$start = getPage($js->pg,$js->psiz,$total);		$data=SQL_QUERY("SELECT c.*,cm.name cr,mode_p FROM (SELECT c.*,COUNT(a.id)as nbr,SUM(a.q)q FROM  ".COMMANDES." c LEFT JOIN ".VENTES." a ON c.id=a.id_cmd GROUP BY c.id) c LEFT JOIN ".COMPTE." cm ON cm.id=c.id_creator  WHERE $date GROUP BY c.id ORDER BY date_vente DESC  LIMIT $start,".$js->psiz);		if($data['test']==true){$modes=getModePay();			foreach($data['data'] as $d){$d=demake($d);$d['total']=(DOUBLE)$d['total'];$d['mode']=isset($modes[$d['mode_p']])?$modes[$d['mode_p']]:'--';			$d['vd']=getDateString($d['date_vente']);			$d['dt_crt']=strtotime($d['dt_crt'])*1000;$d['dt_update']=strtotime($d['dt_update'])*1000;			$d['up']=$d['id_creator']==$d['id_updator']?$d['cr']:getcreator($d['id_updator']);			$newdata[]=$d;}			return array("d"=>$newdata,"count"=>(int)$total,"test"=>true,"num"=>getLastDeviNum(COMMANDES,'n_facture'));		}else{			return array("test"=>false,"errors"=>$data['errors']);		}	}	if($_REQUEST['action']=="save_edit"){global $INFOS_CONFIG;global $MESSAGES;		 $js = json_decode(file_get_contents("php://input"));$data=arrayCastRecursive($js->data);$CLX=array();		 if(isset($data['crd'])){$CLX=array("date_"=>date("Y-m-d H:i:s"),"text"=>FormatString($MESSAGES['Cl_Credit'],array("date"=>$data['date_vente'],"cl"=>$data['cl'],"reste"=>$data['crd']['reste'])),"id_creator"=>$_SESSION[KSJZXID]);}/*notification credit plafond*/		 $ITEMS=$data['items'];unset($data['q'],$data['payed'],$data['statut'],$data['vd'],$data['nbr'],$data['mode'],$data['cr'],$data['items'],$data['cl'],$data['up'],$data['dt_crt'],$data['dt_update'],$data['crd']);		if(isset($data['id'])){$idx=$data['id'];unset($data['id'],$data['ch'],$data['id_creator'],$data['mode_p']);$data['id_updator']=ID_SESSION;$data['dt_update']=date("Y-m-d H:i:s");		$res=SQL_UPDATE(COMMANDES,$data,"id",$idx);		if($res['test']==true){			foreach($ITEMS as $f){			 if($f['q']>0){				if(isset($f['xxx'])){/*$r=SQL_UPDATE(VENTES,array('rm'=>$fild['rm'],"q"=>$f['q'],"id_lot"=>$f['id']),"id",$f['xxx']);*/				}else{$rr=SQL_ADD(VENTES,array("id_creator"=>ID_SESSION,'rm'=>@$fild['rm'],'q'=>$f['q'],"id_lot"=>$f['id'],"id_cmd"=>$idx));}			}}}		}else{$data['id_creator']=ID_SESSION;$data['dt_crt']=date("Y-m-d H:i:s");$dtch=@$data['ch'];unset($data['ch']);			$res=SQL_ADD(COMMANDES,$data);			if($res['test']==true){$ID_COMMADES=$res['last'];			if($data['mode_p']!=3){//3 credit			$payyys=array("enc"=>1,"typee"=>0,"mode"=>$data['mode_p'],"id_v"=>$ID_COMMADES,"mtn"=>$data['total'],"date_"=>date("Y-m-d"),"id_creator"=>ID_SESSION,'dt_crt'=>date("Y-m-d H:i:s"));}			if($data['mode_p']==2){$payyys['enc']=@$dtch['enc']==1?1:0;$dtch['date_ch']=substr($dtch['date_ch'],0,10);$payyys=array_merge($payyys,$dtch);}				$pay=SQL_ADD(PAY,$payyys);				foreach($ITEMS as $fild){				if(isset($fild['id'])){$rr=SQL_ADD(VENTES,array("id_creator"=>ID_SESSION,'rm'=>@$fild['rm'],'q'=>$fild['q'],"id_lot"=>$fild['id'],"id_cmd"=>$ID_COMMADES));}			}}		}			if($res['test']==true){				if(!empty($CLX) and @$INFOS_CONFIG->nf->Cl_Credit){$d=SQL_ADD(NOTIFICATIONS,$CLX);}/*notification credit plafond*/				echoJson(array("test"=>true,"data"=>loaddx()));			}else{echoJson(array("test"=>false,"errors"=>$res['errors']));}		}else if($_REQUEST['action']=="load"){		 echoJson(loaddx());	}else if($_REQUEST['action']=="get"){$items=array();		$id=trim($_REQUEST['id']);$id=(INT)$id;$data=SQL_QUERY("SELECT c.id as xxx,c.id_lot as id,c.q,c.rm,v.prix,v.name,v.date_pre,v.lot,(v.sortie-v.vente)as qt,v.tva FROM ".VENTES." c LEFT JOIN ".VIEW_STOCK." v ON v.idlot=c.id_lot  WHERE id_cmd=:ID",array(":ID"=>$id)); if($data['test']==true){		foreach($data['data'] as $f){$f['q']=(INT)$f['q'];$f['prix']=(DOUBLE)$f['prix']; $f['qt']=(INT)$f['qt']; $f['tva']=(INT)$f['tva']; $f['rm']=(INT)$f['rm'];$f['name']=strtoupper($f['name']);		$f['tt']=(DOUBLE)number_format((($f['prix']*$f['q'])-($f['prix']*$f['rm']*$f['q'])/100),2);		$items[]=$f;}		 echoJson($items);}	}else if($_REQUEST['action']=="delete"){$js = json_decode(file_get_contents("php://input"));$data=arrayCastRecursive($js);		$r=SQL_QUERY("DELETE FROM `".COMMANDES."` WHERE `id` IN(".implode(",",$data['dl']).")");		 echoJson(array("data"=>loaddx(),"test"=>true));	}else if($_REQUEST['action']=="deletell"){$js = json_decode(file_get_contents("php://input"));		$r=SQL_QUERY("DELETE FROM `".VENTES."` WHERE `id`=:ID",array(":ID"=>$js->dl));		 echoJson(array("test"=>true));	}else if($_REQUEST['action']=="getall"){$dataxx=array();$js = json_decode(file_get_contents("php://input"));		$data=SQL_QUERY("SELECT c.id as xxx,c.id_lot as id,c.q,c.rm,v.prix,v.name,v.date_pre,v.lot,(v.sortie-v.vente)as qt,v.tva FROM ".VENTES." c LEFT JOIN ".VIEW_STOCK." v ON v.idlot=c.id_lot  WHERE id_cmd=:ID",array(":ID"=>$js->id));		if($data['test']==true){foreach($data['data'] as $f){$f['q']=(INT)$f['q'];$f['prix']=(DOUBLE)$f['prix']; $f['qt']=(INT)$f['qt']; $f['tva']=(INT)$f['tva']; $f['rm']=(INT)$f['rm'];$f['tt']=(DOUBLE)number_format((($f['prix']*$f['q'])-($f['prix']*$f['rm']*$f['q'])/100),2);		$dataxx['items'][]=$f;}}		if($js->idcl!=""){			$cl=SQL_QUERY("select cl.*,ifnull(SUM(total),0)tt,ifnull(sum(payed),0)payed FROM ".CLIENTS." cl LEFT JOIN (SELECT c.id_cl,total,ifnull(SUM(p.mtn),0)payed FROM ".COMMANDES." c LEFT JOIN ".PAY." p ON p.id_v=c.id GROUP BY c.id) t ON cl.id=t.id_cl   WHERE cl.id=:ID  GROUP by id_cl ORDER BY nom",array(":ID"=>$js->idcl));			if($cl['test']){$dataxx['cl']=@$cl['data'][0]; $dataxx['cl']['reste']=$dataxx['cl']['tt']-$dataxx['cl']['payed'];}		}		$mp=SQL_QUERY("SELECT p.*,c.name as cr,m.name as modep FROM `".PAY."` p LEFT JOIN ".COMPTE." c ON c.id=p.`id_creator` LEFT JOIN ".MODE_P." m ON m.id=p.mode WHERE id_v=:ID",array(":ID"=>$js->id));		if($mp['test']){$dataxx['pay']=@$mp['data'];}		 echoJson($dataxx);	}}else{  echoJson(array("test"=>false,"errors"=>"server not authorized"));exit;}