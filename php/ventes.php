<?php  include_once("cn.php");define("ID_SESSION",$_SESSION[KSJZXID]);if(chekAjax()){	function loaddx(){ 		$total=0;$js = json_decode(file_get_contents("php://input"));		 $year=isset($js->year)?$js->year:date('Y');$mois=isset($js->mois)?$js->mois:date('m'); $date="  YEAR(`date_vente`)='$year'";		if(isset($js->mois)){if($js->mois!="-1"){$date.=" AND MONTH(`date_vente`)='$mois'";}}		$total= SQL_GET_TABLE_SIZE("SELECT count(*)as cnt FROM ".COMMANDES." WHERE   $date  ORDER BY id DESC  ",2);		$newdata=array();$start = getPage($js->pg,$js->psiz,$total);		$data=SQL_QUERY("SELECT c.*,cm.name cr,mode_p FROM (SELECT c.*,COUNT(a.id)as nbr,SUM(a.q)q FROM  ".COMMANDES." c LEFT JOIN ".CMD_ARTICLE." a ON c.id=a.id_cmd GROUP BY c.id) c LEFT JOIN ".COMPTE." cm ON cm.id=c.id_creator  WHERE $date GROUP BY c.id ORDER BY date_vente DESC  LIMIT $start,".$js->psiz);		if($data['test']==true){$modes=getModePay();			foreach($data['data'] as $d){$d=demake($d);$d['total']=(DOUBLE)$d['total'];$d['mode']=isset($modes[$d['mode_p']])?$modes[$d['mode_p']]:'--';			$d['vd']=getDateString($d['date_vente']);			$d['dt_crt']=strtotime($d['dt_crt'])*1000;$d['dt_update']=strtotime($d['dt_update'])*1000;			$d['up']=$d['id_creator']==$d['id_updator']?$d['cr']:getcreator($d['id_updator']);			$newdata[]=$d;}			return array("d"=>$newdata,"count"=>(int)$total,"test"=>true,"num"=>getLastDeviNum(COMMANDES,'n_facture'));		}else{			return array("test"=>false,"errors"=>$data['errors']);		}	}	if($_REQUEST['action']=="save_edit"){global $INFOS_CONFIG;global $MESSAGES;		 $js = json_decode(file_get_contents("php://input"));$data=arrayCastRecursive($js->data);$CLX=array();		 		 $ITEMS=$data['items'];unset($data['q'],$data['payed'],$data['statut'],$data['vd'],$data['nbr'],$data['mode'],$data['cr'],$data['items'],$data['cl'],$data['up'],$data['dt_crt'],$data['dt_update'],$data['crd'],$data['ch']);		$data['id_creator']=ID_SESSION;$data['dt_crt']=date("Y-m-d H:i:s");					$res=SQL_ADD(COMMANDES,$data);			if($res['test']==true){$ID_COMMADES=$res['last'];							foreach($ITEMS as $fild){				if(isset($fild['id'])){$rr=SQL_ADD(CMD_ARTICLE,array("id_creator"=>ID_SESSION,'rm'=>@$fild['rm'],'q'=>$fild['q'],"id_pr"=>$fild['id'],"prix"=>$fild['prix'],"id_cmd"=>$ID_COMMADES));}			}}					if($res['test']==true){								echoJson(array("test"=>true,"data"=>loaddx()));			}else{echoJson(array("test"=>false,"errors"=>$res['errors']));}		}else if($_REQUEST['action']=="load"){		 echoJson(loaddx());	}else if($_REQUEST['action']=="delete"){$js = json_decode(file_get_contents("php://input"));$data=arrayCastRecursive($js);		$r=SQL_QUERY("DELETE FROM `".COMMANDES."` WHERE `id` IN(".implode(",",$data['dl']).")");		 echoJson(array("data"=>loaddx(),"test"=>true));	}else if($_REQUEST['action']=="deletell"){$js = json_decode(file_get_contents("php://input"));		$r=SQL_QUERY("DELETE FROM `".CMD_ARTICLE."` WHERE `id`=:ID",array(":ID"=>$js->dl));		 echoJson(array("test"=>true));	}else if($_REQUEST['action']=="getall"){$dataxx=array();$js = json_decode(file_get_contents("php://input"));		$data=SQL_QUERY("SELECT  p.name,ar.prix,ar.rm,ar.q,p.tva FROM `".CMD_ARTICLE."` ar LEFT JOIN ".PRODUCTS." p ON p.id=ar.id_pr WHERE id_cmd=:ID",array(":ID"=>$js->id));		if($data['test']==true){foreach($data['data'] as $f){$f['q']=(INT)$f['q'];$f['prix']=(DOUBLE)$f['prix'];  $f['tva']=(INT)$f['tva']; $f['rm']=(INT)$f['rm'];$f['tt']=(DOUBLE)number_format((($f['prix']*$f['q'])-($f['prix']*$f['rm']*$f['q'])/100),2);		$dataxx['items'][]=$f;}}						 echoJson($dataxx);	}}else{  echoJson(array("test"=>false,"errors"=>"server not authorized"));exit;}