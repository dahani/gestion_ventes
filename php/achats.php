<?php  include_once("cn.php");define("ID_SESSION",$_SESSION[KSJZXID]);if(chekAjax()){	function loaddx(){ 		$total=0;$js = json_decode(file_get_contents("php://input"));		 $year=isset($js->year)?$js->year:date('Y');$mois=isset($js->mois)?$js->mois:date('m'); $date="  YEAR(`date_en`)='$year'";		if(isset($js->mois)){if($js->mois!="-1"){$date.=" AND MONTH(`date_en`)='$mois'";}}		if(isset($js->extra->four)){if($js->extra->four!="-1"){$date.=" AND  id_four=".$js->extra->four;}}				$total= SQL_GET_TABLE_SIZE("SELECT count(*)as cnt FROM ".STOCK." WHERE   $date  ORDER BY id DESC  ",2);		$newdata=array();$start = getPage($js->pg,$js->psiz,$total);		$data=SQL_QUERY("SELECT s.*,f.nom as frn,c.name as resp,p.name as pr FROM `".STOCK."` s LEFT JOIN ".FOURNISSEURS." f ON f.id=s.id_four LEFT JOIN ".COMPTE." c ON c.id=s.id_creator LEFT JOIN ".PRODUCTS." p ON p.id=s.id_pr WHERE   $date  ORDER BY date_en DESC,id DESC  LIMIT $start,".$js->psiz);		if($data['test']==true){			foreach($data['data'] as $d){$d=demake($d);$d['q']=(INT)$d['q'];			$d['prix_achat']=(DOUBLE)$d['prix_achat'];$d['prix_vente']=(DOUBLE)$d['prix_vente'];			$d['vd']=getDateString($d['date_en']);			$newdata[]=$d;}			return array("d"=>$newdata,"count"=>(int)$total,"test"=>true);		}else{			return array("test"=>false,"errors"=>$data['errors']);		}	}	if($_REQUEST['action']=="save_edit"){		 $js = json_decode(file_get_contents("php://input"),true);$data=$js['data'];$ITEMS=@$data['items'];		 		if(isset($data['id'])){$idx=$data['id'];		$res=SQL_UPDATE(STOCK,array('id_updator'=>ID_SESSION,"dt_update"=>date("Y-m-d H:i:s"),"prix_vente"=>@$data['prix_vente'],"date_en"=>$data['date_en'],'prix_achat'=>@$data['prix_achat'],"q"=>$data['q'],"date_pre"=>@$data['date_pre']),"id",$idx);		}else{			 			$tmp=["dt_crt"=>date("Y-m-d H:i:s"),"id_four"=>$data['id_four'],"date_en"=>$data['date_en'],"id_creator"=>ID_SESSION];			foreach($ITEMS as $fild){				if(isset($fild['id']) and $fild['q']>0){					$tmp['date_pre']=@$fild['date_pre'];$tmp['q']=$fild['q'];					$tmp['prix_achat']=@$fild['prix_achat'];$tmp['prix_vente']=@$fild['prix_vente'];					$tmp['id_pr']=$fild['id'];					$res=SQL_ADD(STOCK,$tmp);				}			}		}			if($res['test']==true){echoJson(array("test"=>true,"data"=>loaddx()));			}else{echoJson(array("test"=>false,"errors"=>$res['errors']));}		}else if($_REQUEST['action']=="load"){		 echoJson(loaddx());	}else if($_REQUEST['action']=="delete"){$js = json_decode(file_get_contents("php://input"));$data=arrayCastRecursive($js);		$r=SQL_QUERY("DELETE FROM `".STOCK."` WHERE `id` IN(".implode(",",$data['dl']).")");		 echoJson(array("data"=>loaddx(),"test"=>true));	}}else{  echoJson(array("test"=>false,"errors"=>"server not authorized"));exit;}