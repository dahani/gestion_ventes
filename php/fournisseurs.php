<?php  include_once("cn.php");require_once '../vendor/autoload.php';use Spatie\Image\Image;
define("ID_SESSION",$_SESSION[KSJZXID]);define("URL","../img/four/");if(chekAjax()){$js = json_decode(file_get_contents("php://input"));	$id=trim(@$js->id);define("IDDX",$id);	function loaddx(){ 		$total=0;$js = json_decode(file_get_contents("php://input"));if(getType($js)=="NULL"){$js = json_decode('{"psiz":"10","pg":"1"}');}		$ORDERBY=" ORDER BY id DESC";		if(isset($js->sort->ord)){$ORDERBY=" ORDER BY {$js->sort->k} ".($js->sort->ord?" DESC":" ASC ");}				 if(!isset($js->q)){$js->q="";}$q=strip_tags($js->q);$q=trim($q);		if(strlen($q)>0){			 $SQL="SELECT f.*,c.name as cr FROM ".FOURNISSEURS." f LEFT JOIN ".COMPTE." c ON c.id=f.id_creator  WHERE  ( `nom`  LIKE :Q  OR `cin`  LIKE :Q OR `addr`  LIKE :Q OR `tel`  LIKE :Q  OR `ville`  LIKE :Q OR `addr` LIKE :Q OR `iff`  LIKE :Q OR f.`email`  LIKE :Q )  $ORDERBY";			$count="SELECT count(*)as cnt  FROM `".FOURNISSEURS."`  WHERE ( `nom`  LIKE :Q  OR `cin`  LIKE :Q OR `addr`  LIKE :Q OR `tel`  LIKE :Q  OR `ville`  LIKE :Q OR `addr` LIKE :Q OR `iff`  LIKE :Q OR `email`  LIKE :Q)   ";			$total= SQL_GET_TABLE_SIZE($count,2,array(":Q"=>'%'.$q.'%'));		}else{$total= SQL_GET_TABLE_SIZE("SELECT count(*)as cnt  FROM `".FOURNISSEURS."`  WHERE  1",2);}		$newdata=array();$start = getPage($js->pg,$js->psiz,$total);		if(strlen($q)>0){			$data=SQL_QUERY($SQL." LIMIT $start,".$js->psiz,array(":Q"=>'%'.$q.'%'));		}else if(isset($_REQUEST['id'])){$id=trim($_REQUEST['id']);$id=(INT)$id;			$data=SQL_QUERY("SELECT f.*,c.name as cr FROM ".FOURNISSEURS." f LEFT JOIN ".COMPTE." c ON c.id=f.id_creator  WHERE f.id=:ID",array(':ID'=>$id));		}else{			$data=SQL_QUERY("SELECT f.*,c.name as cr FROM ".FOURNISSEURS." f LEFT JOIN ".COMPTE." c ON c.id=f.id_creator   $ORDERBY LIMIT $start,".$js->psiz);		}		if($data['test']==true){			foreach($data['data'] as $d){$d=demake($d);unset($d['date_']);$d['nom']=strtoupper($d['nom']);			$d['dt_crt']=strtotime($d['dt_crt'])*1000;$d['dt_update']=strtotime($d['dt_update'])*1000;			$d['up']=$d['id_creator']==$d['id_updator']?$d['cr']:getcreator($d['id_updator']);						$d['image']=$d['logo']!=""?'<a href="img/four/'.$d['logo'].'"   class="without-caption image-link"><img style="width:55px" src="img/four/'.$d['logo'].'" />  </a>':"<span  class='c-blue f-17 show text-center '>----</span>";			
			$newdata[]=$d;			}return array("d"=>$newdata,"count"=>(int)$total,"test"=>true);		}else{			return array("d"=>[],"count"=>0,"test"=>false,"errors"=>$data['errors']);		}	}	if($_REQUEST['action']=="save_edit"){		 $js = json_decode(file_get_contents("php://input"));		 $data = json_decode($_REQUEST['info'],true);		$tmpsrc=isset($data['logo'])?$data['logo']:"";unset($data['dt_crt'],$data['image'],$data['images'],$data['typex'],$data['naiss'],$data['cr'],$data['up'],$data['tt'],$data['payed'],$data['ventes'],$data['reste'],$data['pay'],$data['contacts'],$data['ch'],$data['type'],$data['lots']);		if(isset($_FILES['files'])){ $f=$_FILES['files'];$name=file_exists(URL.$f['name'])?time().$f['name']:$f['name'];					$name.=".webp";				if(file_exists($f['tmp_name'])){					$op1=Image::load($f['tmp_name'])						->fit("stretch",512,512)->quality(60)->optimize()->save(URL.$name);				$data['logo']=$name;			}				}				if($tmpsrc!=@$data['logo']){					if(file_exists(URL.$tmpsrc) and is_file(URL.$tmpsrc)){unlink(URL.$tmpsrc);}				}
		if(isset($data['id'])){$idx=$data['id'];unset($data['id']);$data['id_updator']=ID_SESSION;$data['dt_update']=date("Y-m-d H:i:s");$res=SQL_UPDATE(FOURNISSEURS,$data,"id",$idx);		}else{$data['id_creator']=ID_SESSION;$data['dt_crt']=date("Y-m-d H:i:s");$res=SQL_ADD(FOURNISSEURS,$data);}		if($res['test']==true){			 echoJson(array("test"=>true,"data"=>loaddx()));		}else{			 echoJson(array("test"=>false,"errors"=>$res['errors']));		}			}else if($_REQUEST['action']=="load"){		 echoJson(loaddx());	}else if($_REQUEST['action']=="delete"){$js = json_decode(file_get_contents("php://input"));		$data=arrayCastRecursive($js);		$r=SQL_QUERY("DELETE FROM `".FOURNISSEURS."` WHERE `id` IN(".implode(",",$data['dl']).")");		 echoJson(array("data"=>loaddx(),"test"=>true));	}else if($_REQUEST['action']=="getall"){		$data=SQL_QUERY("select cl.*,ifnull(SUM(total),0)tt,ifnull(sum(payed),0)payed FROM ".FOURNISSEURS." cl LEFT JOIN (SELECT c.id_four,(qn*plot) as total,ifnull(SUM(p.mtn),0)payed FROM ".STOCK." c LEFT JOIN ".PAY." p ON p.id_achat=c.id  WHERE c.id_four=:ID GROUP BY c.id) t ON cl.id=t.id_four   WHERE cl.id=:ID  GROUP by id_four ORDER BY nom",array(":ID"=>IDDX));		if($data['test'] && isset($data['data'][0])){$CLX=$data['data'][0];$CLX['dt_crt']=strtotime($CLX['dt_crt'])*1000;$CLX['dt_update']=strtotime($CLX['dt_update'])*1000;$CLX['up']=$CLX['id_creator']==$CLX['id_updator']?$CLX['cr']:getcreator($CLX['id_updator']);		$CLX['reste']=$CLX['tt']-$CLX['payed'];			$CLX['lots']=getLots();			$cn=SQL_SELECT(CONTACTS,'id_fr',IDDX);if($cn['test']){$CLX['contacts']=$cn['data'];}			$ch=SQL_QUERY("SELECT c.n_facture,id_cl,ch.mtn,ch.num,ch.bp,ch.date_ch,enc,cm.name cr FROM `".PAY."` ch LEFT JOIN  ".COMMANDES." c ON ch.id_v=c.id   LEFT JOIN ".COMPTE." cm  ON cm.id=ch.`id_creator` WHERE typee=0 AND ch.mode=2 AND c.id_cl=:ID",array(":ID"=>IDDX));			$ch=SQL_QUERY("SELECT c.bl as n_facture,(qn*plot)total,ch.mtn,ch.num,ch.bp,ch.date_ch,enc,cm.name cr  FROM ".STOCK." c LEFT JOIN  `".PAY."` ch  ON ch.id_achat=c.id  LEFT JOIN ".FOURNISSEURS." fr ON fr.id=c.id_four LEFT JOIN ".COMPTE." cm  ON (cm.id=ch.`id_creator`) WHERE typee=1 AND ch.mode=2 AND c.id_four=:ID ",array(":ID"=>IDDX));			if($ch['test']){$CLX['ch']=$ch['data'];}			echoJson(array("test"=>true,"data"=>$CLX));		}else{			 echoJson(array("test"=>false,"errors"=>$data['errors']));		}		}else if($_REQUEST['action']=="lots?action=load"){		echoJson(getLots());	}}else{  echoJson(array("test"=>false,"errors"=>"server not authorized"));exit;}function getLots(){$newdata=array();$total=0;$js = json_decode(file_get_contents("php://input"));if(getType($js)=="NULL"){$js = json_decode('{"pg":"1"}');}return [];	$total= SQL_GET_TABLE_SIZE("SELECT count(*)as cnt  FROM `".STOCK."`  WHERE  id_four=:ID ",2,array(":ID"=>IDDX));	$start = getPage(isset($js->pg)?$js->pg:1,10,$total);	$data=SQL_QUERY("SELECT l.*,c.name,(qn*plot) as total FROM ".STOCK." l LEFT JOIN ".COMPTE." c ON c.id=l.id_creator WHERE id_four=:ID ORDER BY date_pre ASC LIMIT $start,10",array(":ID"=>IDDX));	if($data['test']==true){foreach($data['data'] as $d){$d=demake($d);$newdata[]=$d;}}	return array("d"=>$newdata,"count"=>(int)$total,"test"=>true);}