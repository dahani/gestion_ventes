<?php  include_once("cn.php");define("ID_SESSION",$_SESSION[KSJZXID]);if(chekAjax()){$js = json_decode(file_get_contents("php://input"));	$id=trim(@$js->id);define("IDDX",$id);	define("TABLE",PRODUCTS);	define("URL",'../img/produits/');	function loaddx(){ 		$total=0;$js = json_decode(file_get_contents("php://input"));$where="";if(getType($js)=="NULL"){$js = json_decode('{"psiz":"10","pg":"1"}');}		$ORDERBY=" ORDER BY id DESC";		if(isset($js->sort->ord)){$ORDERBY=" ORDER BY {$js->sort->k} ".($js->sort->ord?" DESC":" ASC ");}				if(isset($js->extra->level)){if($js->extra->level!="-1"){$where.=" WHERE id_gamme=".$js->extra->level;}}		 if(!isset($js->q)){$js->q="";}$q=strip_tags($js->q);$q=trim($q);		if(strlen($q)>0){			 $SQL="SELECT * FROM ".TABLE." t   WHERE   (  `name`  LIKE :Q  OR  `code`  LIKE :Q  )  $ORDERBY";			$count="SELECT count(*)as cnt  FROM `".TABLE."`  WHERE  ( `name`  LIKE :Q  OR  `code`  LIKE :Q )   ";			$total= SQL_GET_TABLE_SIZE($count,2,array(":Q"=>'%'.$q.'%'));		}else{$total= SQL_GET_TABLE_SIZE(TABLE);		$total= SQL_GET_TABLE_SIZE("SELECT count(*)as cnt  FROM ".TABLE."  $where",2);}		$newdata=array();		if(strlen($q)>0){$start = @getPage(@$js->pg,@$js->psiz,$total);			$data=SQL_QUERY($SQL." LIMIT $start,".$js->psiz,array(":Q"=>'%'.$q.'%'));		}else if(isset($_REQUEST['id'])){$id=trim($_REQUEST['id']);$id=(INT)$id;			$data=SQL_SELECT(TABLE,"id",$id);		}else if(isset($_REQUEST['code'])){$code=trim($_REQUEST['code']);$code=(INT)$code;			$data=SQL_SELECT(TABLE,"code",$code);		}else{$start = @getPage(@$js->pg,@$js->psiz,$total);			$data=SQL_QUERY("SELECT *  FROM `".TABLE."`   $where  $ORDERBY LIMIT $start,".$js->psiz);		}				if($data['test']==true){			foreach($data['data'] as $d){$d=demake($d);;$d['prix']=(DOUBLE)$d['prix'];			$d['qn_min']=(DOUBLE)$d['qn_min'];			$d['image']=$d['img']!=""?'<a href="img/produits/'.$d['img'].'"   class="without-caption image-link"><img style="width:55px" src="img/produits/'.$d['img'].'" />  </a>':"<span  class='c-blue f-17 show text-center '>----</span>";			$newdata[]=$d;			}return array("d"=>$newdata,"count"=>(int)$total,"test"=>true);		}else{			return array("d"=>[],"count"=>0,"test"=>false,"errors"=>$data['errors']);		}	}	if($_REQUEST['action']=="save_edit"){$js = json_decode(file_get_contents("php://input"));$data=arrayCastRecursive(json_decode($_REQUEST['info']));$tmpsrc=isset($data['img'])?$data['img']:"";unset($data['gm'],$data['cr'],$data['up'],$data['lots'],$data['str'],$data['inv'],$data['sortie'],$data['image']);	if(isset($_FILES['files'])){$f=$_FILES['files'];	$f['name']=file_exists(URL.$f['name'])?time().$f['name']:$f['name'];$data['img']=$f['name'];	if(!move_uploaded_file($f['tmp_name'],URL.$f['name']) OR $f['error']>0){echoJson(array("test"=>false,"errors"=>"Error uploading image"));}	}	unset($data['nv']);		if($tmpsrc!=@$data['img']){if(file_exists(URL.$tmpsrc) and is_file(URL.$tmpsrc)){unlink(URL.$tmpsrc);}}		if(isset($data['id'])){$idx=$data['id'];$data['id_updator']=ID_SESSION;$data['dt_update']=date("Y-m-d H:i:s");unset($data['id']);$res=SQL_UPDATE(TABLE,$data,"id",$idx,false);		}else{$data['id_creator']=ID_SESSION;$data['dt_crt']=date("Y-m-d H:i:s");$res=SQL_ADD(TABLE,$data,false);}		if($res['test']==true){			echoJson(array("test"=>true,"data"=>loaddx()));		}else{			echoJson(array("test"=>false,"errors"=>$res['errors']));		}			}else if($_REQUEST['action']=="load"){		echoJson(loaddx());	}else if($_REQUEST['action']=="delete"){$js = json_decode(file_get_contents("php://input"));$data=arrayCastRecursive($js);	$sq=SQL_QUERY("SELECT * FROM `".TABLE."` WHERE `id` IN(".implode(",",$data['dl']).")");	if($sq['test']==true){		foreach($sq['data'] as $f){		if(file_exists(URL.$f['img']) and is_file(URL.$f['img'])){unlink(URL.$f['img']);}			}	}		$r=SQL_QUERY("DELETE FROM `".TABLE."` WHERE `id` IN(".implode(",",$data['dl']).")");		echoJson(array("data"=>loaddx(),"test"=>true));	}/*else if($_REQUEST['action']=="import"){$js = json_decode(file_get_contents("php://input"));		$seting= array();foreach($js->st as $k=>$v){$seting[$v->value]=@$v->eqv;}			$count=0;		foreach($js->data as $d){		$d=arrayCastRecursive($d);$row=array("id_level"=>@$js->l,"fname"=>@$d[$seting['fname']],"lname"=>@$d[$seting['lname']],"tel"=>@$d[$seting['tel']],"email"=>@$d[$seting['email']],"addr"=>@$d[$seting['addr']]);		$res=SQL_ADD(TABLE,$row);if($res['test']==true){$count++;}		}		if($count>0){				echoJson(array("test"=>true,"data"=>loaddx(),"text"=>$count." lignes importeÃ©"));		}else{			echoJson(array("test"=>false,"errors"=>$res['errors']));		}	}*/else if($_REQUEST['action']=="getall"){$js = json_decode(file_get_contents("php://input"));		$data=SQL_QUERY("SELECT m.* ,cc.name as cr,s.ventes vt,s.achats ach FROM `".PRODUCTS."` m LEFT JOIN ".COMPTE." cc ON cc.id=m.id_creator LEFT JOIN ".PRODUCTS_STATE." s on s.id_pr=m.id WHERE m.id=:ID",array(":ID"=>IDDX));		if($data['test'] && isset($data['data'][0])){$CLX=$data['data'][0];$CLX['dt_crt']=strtotime($CLX['dt_crt'])*1000;$CLX['dt_update']=strtotime($CLX['dt_update'])*1000;$CLX['up']=$CLX['id_creator']==$CLX['id_updator']?$CLX['cr']:getcreator($CLX['id_updator']);		$CLX['prix']=(DOUBLE)$CLX['prix'];$CLX['qn_min']=(DOUBLE)$CLX['qn_min'];						$CLX['ventes']=getVentes();			echoJson(array("test"=>true,"data"=>$CLX));		}else{			 echoJson(array("test"=>false,"errors"=>@$data['errors']));		}		}else if($_REQUEST['action']=="ventes?action=load"){		echoJson(getVentes());	}elseif($_REQUEST['action']=="add_product"){	$js = json_decode(file_get_contents("php://input"),true);	$js['id_creator']=ID_SESSION;		$res=SQL_ADD(PRODUCTS,$js);		if($res['test']==true){			 echoJson(array("test"=>true,"last"=>$res['last']));		}else{			 echoJson(array("test"=>false,"errors"=>$res['errors']));		}}}else{echo  echoJson(array("test"=>false,"errors"=>"server not authorized"));exit;}function getVentes(){$newdata=array();$total=0;$js = json_decode(file_get_contents("php://input"));if(getType($js)=="NULL"){$js = json_decode('{"pg":"1"}');}	$total= SQL_GET_TABLE_SIZE("SELECT count(*)as cnt  FROM `".CMD_ARTICLE."`  WHERE  id_pr=:ID ",2,array(":ID"=>IDDX));	$start = getPage(isset($js->pg)?$js->pg:1,10,$total);	$data=SQL_QUERY("SELECT l.*,c.name,cm.n_facture,cm.date_vente  FROM ".CMD_ARTICLE." l LEFT JOIN ".COMPTE." c ON c.id=l.id_creator LEFT JOIN ".COMMANDES." cm  ON cm.id=l.id_cmd WHERE id_pr=:ID LIMIT $start,10",array(":ID"=>IDDX));	if($data['test']==true){foreach($data['data'] as $d){$d=demake($d);$newdata[]=$d;}}	return array("d"=>$newdata,"count"=>(int)$total,"test"=>true);}